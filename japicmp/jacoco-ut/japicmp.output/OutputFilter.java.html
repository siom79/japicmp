<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OutputFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">japicmp</a> &gt; <a href="index.source.html" class="el_package">japicmp.output</a> &gt; <span class="el_source">OutputFilter.java</span></div><h1>OutputFilter.java</h1><pre class="source lang-java linenums">package japicmp.output;

import com.google.common.collect.ImmutableList;
import japicmp.config.Options;
import japicmp.model.*;
import japicmp.util.ModifierHelper;

import java.util.Collections;
import java.util.Comparator;
import java.util.Iterator;
import java.util.List;

public class OutputFilter extends Filter {
	private final Options options;

<span class="fc" id="L16">	public OutputFilter(Options options) {</span>
<span class="fc" id="L17">		this.options = options;</span>
<span class="fc" id="L18">	}</span>

	public void filter(List&lt;JApiClass&gt; jApiClasses) {
<span class="fc" id="L21">		filter(jApiClasses, new FilterVisitor() {</span>
			@Override
			public void visit(Iterator&lt;JApiField&gt; iterator, JApiField element) {
<span class="fc" id="L24">				boolean remove = false;</span>
<span class="pc bpc" id="L25" title="1 of 2 branches missed.">				if (options.isOutputOnlyModifications()) {</span>
<span class="nc bnc" id="L26" title="All 2 branches missed.">					if (element.getChangeStatus() == JApiChangeStatus.UNCHANGED) {</span>
<span class="nc bnc" id="L27" title="All 4 branches missed.">						if (hasOnlyUnchangedAnnotations(element) &amp;&amp; element.isSourceCompatible()) {</span>
<span class="nc" id="L28">							remove = true;</span>
						}
					}
				}
<span class="pc bpc" id="L32" title="1 of 2 branches missed.">				if (options.isOutputOnlyBinaryIncompatibleModifications()) {</span>
<span class="nc bnc" id="L33" title="All 2 branches missed.">					if (element.isBinaryCompatible()) {</span>
<span class="nc" id="L34">						remove = true;</span>
					}
				}
<span class="pc bpc" id="L37" title="1 of 2 branches missed.">				if (!ModifierHelper.matchesModifierLevel(element, OutputFilter.this.options.getAccessModifier())) {</span>
<span class="nc" id="L38">					remove = true;</span>
				}
<span class="fc bfc" id="L40" title="All 2 branches covered.">				if (!ModifierHelper.includeSynthetic(element, options)) {</span>
<span class="fc" id="L41">					remove = true;</span>
				}
<span class="fc bfc" id="L43" title="All 2 branches covered.">				if (remove) {</span>
<span class="fc" id="L44">					iterator.remove();</span>
				}
<span class="fc" id="L46">			}</span>

			private boolean hasOnlyUnchangedAnnotations(JApiHasAnnotations jApiHasAnnotations) {
<span class="nc" id="L49">				boolean hasOnlyUnchangedAnnotations = true;</span>
<span class="nc bnc" id="L50" title="All 2 branches missed.">				for (JApiAnnotation jApiAnnotation : jApiHasAnnotations.getAnnotations()) {</span>
<span class="nc bnc" id="L51" title="All 2 branches missed.">					if (jApiAnnotation.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L52">						hasOnlyUnchangedAnnotations = false;</span>
<span class="nc" id="L53">						break;</span>
					}
<span class="nc" id="L55">				}</span>
<span class="nc" id="L56">				return hasOnlyUnchangedAnnotations;</span>
			}

			@Override
			public void visit(Iterator&lt;JApiAnnotation&gt; iterator, JApiAnnotation element) {
<span class="fc" id="L61">				boolean remove = false;</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">				if (options.isOutputOnlyModifications()) {</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">					if (element.getChangeStatus() == JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L64">						remove = true;</span>
					}
				}
<span class="pc bpc" id="L67" title="1 of 2 branches missed.">				if (options.isOutputOnlyBinaryIncompatibleModifications()) {</span>
<span class="nc bnc" id="L68" title="All 2 branches missed.">					if (element.isBinaryCompatible()) {</span>
<span class="nc" id="L69">						remove = true;</span>
					}
				}
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">				if (remove) {</span>
<span class="nc" id="L73">					iterator.remove();</span>
				}
<span class="fc" id="L75">			}</span>

			@Override
			public void visit(JApiSuperclass jApiSuperclass) {
				// cannot remove superclass
<span class="fc" id="L80">			}</span>

			@Override
			public void visit(Iterator&lt;JApiImplementedInterface&gt; iterator, JApiImplementedInterface element) {
<span class="fc" id="L84">				boolean remove = false;</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">				if (options.isOutputOnlyModifications()) {</span>
<span class="nc bnc" id="L86" title="All 4 branches missed.">					if (element.getChangeStatus() == JApiChangeStatus.UNCHANGED &amp;&amp; element.isSourceCompatible()) {</span>
<span class="nc" id="L87">						remove = true;</span>
					}
				}
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">				if (options.isOutputOnlyBinaryIncompatibleModifications()) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">					if (element.isBinaryCompatible()) {</span>
<span class="nc" id="L92">						remove = true;</span>
					}
				}
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">				if (remove) {</span>
<span class="nc" id="L96">					iterator.remove();</span>
				}
<span class="fc" id="L98">			}</span>

			@Override
			public void visit(Iterator&lt;JApiConstructor&gt; iterator, JApiConstructor element) {
<span class="fc" id="L102">				boolean remove = false;</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">				if (options.isOutputOnlyModifications()) {</span>
<span class="nc bnc" id="L104" title="All 4 branches missed.">					if (element.getChangeStatus() == JApiChangeStatus.UNCHANGED &amp;&amp; element.isSourceCompatible()) {</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">						if (hasOnlyUnchangedAnnotations(element)) {</span>
<span class="nc" id="L106">							remove = true;</span>
						}
					}
				}
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">				if (options.isOutputOnlyBinaryIncompatibleModifications()) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">					if (element.isBinaryCompatible()) {</span>
<span class="nc" id="L112">						remove = true;</span>
					}
				}
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">				if (!ModifierHelper.matchesModifierLevel(element, OutputFilter.this.options.getAccessModifier())) {</span>
<span class="nc" id="L116">					remove = true;</span>
				}
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">				if (!ModifierHelper.includeSynthetic(element, options)) {</span>
<span class="nc" id="L119">					remove = true;</span>
				}
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">				if (remove) {</span>
<span class="nc" id="L122">					iterator.remove();</span>
				}
<span class="fc" id="L124">			}</span>

			@Override
			public void visit(Iterator&lt;JApiMethod&gt; iterator, JApiMethod element) {
<span class="fc" id="L128">				boolean remove = false;</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">				if (options.isOutputOnlyModifications()) {</span>
<span class="nc bnc" id="L130" title="All 4 branches missed.">					if (element.getChangeStatus() == JApiChangeStatus.UNCHANGED &amp;&amp; element.isSourceCompatible()) {</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">						if (hasOnlyUnchangedAnnotations(element)) {</span>
<span class="nc" id="L132">							remove = true;</span>
						}
					}
				}
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">				if (options.isOutputOnlyBinaryIncompatibleModifications()) {</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">					if (element.isBinaryCompatible()) {</span>
<span class="nc" id="L138">						remove = true;</span>
					}
				}
<span class="fc bfc" id="L141" title="All 2 branches covered.">				if (!ModifierHelper.matchesModifierLevel(element, OutputFilter.this.options.getAccessModifier())) {</span>
<span class="fc" id="L142">					remove = true;</span>
				}
<span class="fc bfc" id="L144" title="All 2 branches covered.">				if (!ModifierHelper.includeSynthetic(element, options)) {</span>
<span class="fc" id="L145">					remove = true;</span>
				}
<span class="fc bfc" id="L147" title="All 2 branches covered.">				if (remove) {</span>
<span class="fc" id="L148">					iterator.remove();</span>
				}
<span class="fc" id="L150">			}</span>

			@Override
			public void visit(Iterator&lt;JApiClass&gt; iterator, JApiClass jApiClass) {
<span class="fc" id="L154">				boolean remove = false;</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">				if (options.isOutputOnlyModifications()) {</span>
<span class="nc bnc" id="L156" title="All 4 branches missed.">					if (jApiClass.getChangeStatus() == JApiChangeStatus.UNCHANGED &amp;&amp; jApiClass.isSourceCompatible()) {</span>
<span class="nc" id="L157">						ImmutableList&lt;Boolean&gt; list = findOneChangedElement(jApiClass);</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">						if (list.isEmpty()) { //filter out this class if it does not have any changed element (e.g. annotations)</span>
<span class="nc" id="L159">							remove = true;</span>
						}
					}
				}
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">				if (options.isOutputOnlyBinaryIncompatibleModifications()) {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">					if (jApiClass.isBinaryCompatible()) {</span>
<span class="nc" id="L165">						remove = true;</span>
					}
				}
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">				if (!ModifierHelper.matchesModifierLevel(jApiClass, OutputFilter.this.options.getAccessModifier())) {</span>
<span class="nc" id="L169">					remove = true;</span>
				}
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">				if (jApiClass.getJavaObjectSerializationCompatible().isIncompatible()) {</span>
<span class="nc" id="L172">					remove = false;</span>
				}
<span class="fc bfc" id="L174" title="All 2 branches covered.">				if (!ModifierHelper.includeSynthetic(jApiClass, options)) {</span>
<span class="fc" id="L175">					remove = true;</span>
				}
<span class="fc bfc" id="L177" title="All 2 branches covered.">				if (remove) {</span>
<span class="fc" id="L178">					iterator.remove();</span>
				}
<span class="fc" id="L180">			}</span>

			private ImmutableList&lt;Boolean&gt; findOneChangedElement(JApiClass jApiClass) {
<span class="nc" id="L183">				final ImmutableList.Builder&lt;Boolean&gt; builder = ImmutableList.builder();</span>
<span class="nc" id="L184">				Filter.filter(Collections.singletonList(jApiClass), new FilterVisitor() {</span>
					@Override
					public void visit(Iterator&lt;JApiClass&gt; iterator, JApiClass jApiClass) {
<span class="nc" id="L187">						evaluateAnnotations(jApiClass);</span>
<span class="nc" id="L188">					}</span>

					@Override
					public void visit(Iterator&lt;JApiMethod&gt; iterator, JApiMethod jApiMethod) {
<span class="nc bnc" id="L192" title="All 2 branches missed.">						if (ModifierHelper.matchesModifierLevel(jApiMethod, OutputFilter.this.options.getAccessModifier())) {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">							if (jApiMethod.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L194">								builder.add(Boolean.TRUE);</span>
							} else {
<span class="nc" id="L196">								evaluateAnnotations(jApiMethod);</span>
							}
						}
<span class="nc" id="L199">					}</span>

					@Override
					public void visit(Iterator&lt;JApiConstructor&gt; iterator, JApiConstructor jApiConstructor) {
<span class="nc bnc" id="L203" title="All 2 branches missed.">						if (ModifierHelper.matchesModifierLevel(jApiConstructor, OutputFilter.this.options.getAccessModifier())) {</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">							if (jApiConstructor.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L205">								builder.add(Boolean.TRUE);</span>
							} else {
<span class="nc" id="L207">								evaluateAnnotations(jApiConstructor);</span>
							}
						}
<span class="nc" id="L210">					}</span>

					@Override
					public void visit(Iterator&lt;JApiImplementedInterface&gt; iterator, JApiImplementedInterface jApiImplementedInterface) {
<span class="nc bnc" id="L214" title="All 2 branches missed.">						if (jApiImplementedInterface.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L215">							builder.add(Boolean.TRUE);</span>
						}
<span class="nc" id="L217">					}</span>

					@Override
					public void visit(Iterator&lt;JApiField&gt; iterator, JApiField jApiField) {
<span class="nc bnc" id="L221" title="All 2 branches missed.">						if (ModifierHelper.matchesModifierLevel(jApiField, OutputFilter.this.options.getAccessModifier())) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">							if (jApiField.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L223">								builder.add(Boolean.TRUE);</span>
							} else {
<span class="nc" id="L225">								evaluateAnnotations(jApiField);</span>
							}
						}
<span class="nc" id="L228">					}</span>

					private void evaluateAnnotations(JApiHasAnnotations jApiHasAnnotations) {
<span class="nc bnc" id="L231" title="All 2 branches missed.">						for (JApiAnnotation jApiAnnotation : jApiHasAnnotations.getAnnotations()) {</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">							if (jApiAnnotation.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L233">								builder.add(Boolean.TRUE);</span>
							}
<span class="nc" id="L235">						}</span>
<span class="nc" id="L236">					}</span>

					@Override
					public void visit(Iterator&lt;JApiAnnotation&gt; iterator, JApiAnnotation jApiAnnotation) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">						if (jApiAnnotation.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L241">							builder.add(Boolean.TRUE);</span>
						}
<span class="nc" id="L243">					}</span>

					@Override
					public void visit(JApiSuperclass jApiSuperclass) {
<span class="nc bnc" id="L247" title="All 2 branches missed.">						if (jApiSuperclass.getChangeStatus() != JApiChangeStatus.UNCHANGED) {</span>
<span class="nc" id="L248">							builder.add(Boolean.TRUE);</span>
						}
<span class="nc" id="L250">					}</span>
				});
<span class="nc" id="L252">				return builder.build();</span>
			}
		});
<span class="fc" id="L255">	}</span>

	public static void sortClassesAndMethods(List&lt;JApiClass&gt; jApiClasses) {
<span class="fc" id="L258">		Collections.sort(jApiClasses, new Comparator&lt;JApiClass&gt;() {</span>
			public int compare(JApiClass o1, JApiClass o2) {
<span class="fc" id="L260">				return o1.getFullyQualifiedName().compareToIgnoreCase(o2.getFullyQualifiedName());</span>
			}
		});
<span class="fc bfc" id="L263" title="All 2 branches covered.">		for (JApiClass jApiClass : jApiClasses) {</span>
<span class="fc" id="L264">			Collections.sort(jApiClass.getMethods(), new Comparator&lt;JApiMethod&gt;() {</span>
				public int compare(JApiMethod o1, JApiMethod o2) {
<span class="fc" id="L266">					return o1.getName().compareToIgnoreCase(o2.getName());</span>
				}
			});
<span class="fc" id="L269">		}</span>
<span class="fc" id="L270">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>